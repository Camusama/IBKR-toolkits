# Practice 3: 高阶期权策略调仓指南

## 📋 策略汇总

| 策略 | 适用场景 | 调仓触发条件 |
|------|---------|-------------|
| Demo 11: Covered Call | 震荡/慢牛 | 到期前展期 |
| Demo 12: Iron Condor | 横盘震荡 | 价格接近边界/止盈止损 |
| Demo 13: Vol Mean Reversion | IV 极端时 | IV 回归/止盈止损 |
| Demo 14: Butterfly | 精准押注价位 | 到期前平仓 |
| Demo 15: Calendar | 时间衰减套利 | 近期到期前展期 |
| Demo 16: Jade Lizard | 偏多市场 | 价格突破/止盈止损 |
| Demo 17: Iron Butterfly | 强烈看横盘 | 价格偏离中点 |
| Demo 18: Strangle | 押注波动率 | 突破/止盈止损 |
| Demo 19: Ratio Spread | 适度上涨 | 上方风险控制 |

---

## 🔧 通用调仓规则

### 1. 止盈止损（所有策略通用）

```
止盈条件:
  - 盈利达到初始权利金的 50% → 平仓
  - 接近最大盈利点 → 考虑提前锁定

止损条件:
  - 亏损达到初始权利金的 100% → 止损
  - 价格大幅突破盈利区间 → 立即止损
```

### 2. 时间管理

```
距到期 > 7 天: 正常持有
距到期 5-7 天: 密切关注，准备展期
距到期 < 5 天: 
  - 盈利 > 30%: 直接平仓
  - 盈利 < 30%: 展期到下一周期
距到期 < 1 天: 必须处理（平仓或展期）
```

### 3. 价格危险区域

```
Iron Condor / Iron Butterfly / Strangle:
  - 价格接近卖出行权价 2% → 预警
  - 价格触及卖出行权价 → 考虑调整
  - 价格突破买入行权价 → 必须止损

Butterfly:
  - 偏离中点 > 3% → 预警
  - 偏离中点 > 5% → 考虑止损
```

---

## 📅 每日运行指南

### Cron 配置示例

```bash
# 美东时间 9:35 和 15:30 检查
35 9,15 * * 1-5 cd /path/to/project && IC_MODE=daily uv run demo12_iron_condor_enhanced.py

# 或者只在开盘后检查一次
35 9 * * 1-5 cd /path/to/project && IC_MODE=daily uv run demo12_iron_condor_enhanced.py
```

### 环境变量

```bash
# 运行模式
IC_MODE=daily           # 单次检查后退出
IC_MODE=continuous      # 持续监控

# 策略参数
IC_SYMBOL=AAPL          # 标的
IC_CONTRACTS=1          # 合约数量
IC_PROFIT_TARGET=0.50   # 止盈目标
IC_STOP_LOSS=1.0        # 止损阈值
IC_ROLL_DAYS=5          # 展期天数

# 模拟模式
IC_SIMULATION=true      # 模拟交易
IC_SIMULATION=false     # 真实交易
```

---

## 🎯 各策略详细调仓逻辑

### Demo 12: Iron Condor (铁鹰策略)

```
调仓触发:
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  下移 ⬅️ [卖Put] ←── 安全区间 ──→ [卖Call] ➡️ 上移         │
│         $266              $280           $294               │
│            ↑                               ↑                │
│         危险区域                        危险区域            │
│                                                             │
└─────────────────────────────────────────────────────────────┘

动作:
1. 价格接近 Put 行权价 → 下移 Put Spread
2. 价格接近 Call 行权价 → 上移 Call Spread
3. 距到期 < 5 天 → 展期
4. 盈利 50% → 止盈
5. 亏损 100% → 止损
```

### Demo 14: Butterfly (蝴蝶策略)

```
调仓触发:
              ↗ 最大盈利 ↘
        $265 ─────●────── $295
               $280
              (中点)

动作:
1. 价格偏离中点 > 5% → 预警
2. 距到期 < 3 天 → 平仓（不建议展期）
3. 盈利 50% → 止盈
4. 亏损 80% → 止损
```

### Demo 15: Calendar Spread (日历价差)

```
调仓触发:
┌─────────────┐      ┌─────────────┐
│ 近期 (卖)   │  →→  │ 远期 (买)   │
│ 2周后到期   │      │ 4周后到期   │
└─────────────┘      └─────────────┘
      ↓
   时间衰减快

动作:
1. 近期期权到期前 1-2 天 → 展期（买入平仓近期，卖出新近期）
2. 价格偏离行权价 > 5% → 考虑止损
3. 盈利 30% → 止盈
4. 亏损 50% → 止损
```

### Demo 16: Jade Lizard (翡翠蜥蜴)

```
调仓触发:
  [卖Put] ←← 安全区间 →→ [卖Call → 买Call]
   $266         $280          $294   $308
     ↓                           ↓
  下跌风险无限              上涨风险有限

动作:
1. 价格低于 Put 行权价 → 考虑买入保护 Put 或止损
2. 价格高于 Call Spread → 风险有限，可持有
3. 盈利 50% → 止盈
4. 下跌亏损 > 初始权利金 → 止损
```

### Demo 17: Iron Butterfly (铁蝴蝶)

```
调仓触发:
  买Put ← 卖Put = 卖Call → 买Call
  $266     $280   $280      $294
              ↑
           ATM (盈利最大点)

动作:
1. 价格偏离 ATM > 3% → 预警
2. 价格偏离 ATM > 5% → 考虑调整
3. 距到期 < 5 天 → 平仓或展期
4. 盈利 50% → 止盈
5. 亏损 100% → 止损
```

### Demo 18: Strangle (宽跨式)

```
Long Strangle (做多波动率):
  买Put ←← 等待突破 →→ 买Call
  $266                    $294
         ↓ 盈亏平衡区 ↓
        $262.5    $297.5

动作:
1. 价格突破盈亏平衡 → 止盈
2. 盈利 50% → 止盈
3. 亏损 50% → 止损
4. 距到期 < 7 天且无突破迹象 → 考虑平仓

Short Strangle (做空波动率):
动作:
1. 价格突破行权价 → 立即止损！
2. 盈利 50% → 止盈
3. 亏损 50% → 止损
```

### Demo 19: Ratio Spread (比率价差)

```
调仓触发:
  买1张$280 ← 卖2张$294 → 裸卖风险!
                 ↑
            最大盈利点
                 ↓
       超过这里风险无限！

动作:
1. 价格超过卖出行权价 → 预警
2. 价格超过卖出行权价 3% → 必须止损
3. 价格接近最大盈利点 + 盈利 > 30% → 建议止盈
4. 距到期 < 5 天 → 评估后平仓
```

---

## 📁 状态文件

仓位状态保存在 `.states/` 目录下：

```
.states/
├── iron_condor_aapl.json
├── butterfly_aapl.json
├── calendar_aapl.json
└── ...
```

JSON 文件结构：
```json
{
  "position": {
    "short_call_strike": 294,
    "short_put_strike": 266,
    "expiry": "20241220",
    "initial_credit": 350.0,
    "current_value": 280.0
  },
  "last_updated": "2024-12-10T09:35:00",
  "symbol": "AAPL"
}
```

---

## ⚠️ 风险提示

1. **模拟模式测试**：首次使用请确保 `SIMULATION=true`
2. **资金管理**：每个策略不超过总资金 5%
3. **流动性**：选择高流动性标的（AAPL, SPY, QQQ 等）
4. **财报风险**：避免在财报期间持有
5. **止损纪律**：严格执行止损，不要心存侥幸
